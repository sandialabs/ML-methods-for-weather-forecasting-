---
title: "Intial Grouped Feature Importance"
subtitle: "Group Feature Importance from Intial Tuned Models"
author: "Jacob Johnson"
date: today
format: 
  html:
    embed-resources: true
    toc: true
---


```{r}
########################################
########################################
## 02.1-Initial_GPFI.qmd              ##
## Jacob Johnson                      ##
## ---------------------------------- ##
## Quarto document to summarize the   ##
## feature importance results from    ##
## the models with the best RMSE from ##
## the tuning done in 01              ##
## - Loads feature importance results ##
## - Plots feature importance         ##
########################################
########################################
```

# Set Up

```{r message = FALSE}
## Load packages
library(dplyr)
library(ggplot2)
library(purrr)
library(stringr)
library(gridExtra)
library(tidyr)
library(wesanderson)
```

Specify file path: 

```{r}
## Path for working locally
local_fp = "//cee/projects/subseasonal_extreme/"
## Path for working on the CEE Compute Server
cee_fp = "/projects/subseasonal_extreme/"

## Select which path to use
fp = local_fp
```

# Data Steps 

Load climate inputs: 

```{r}
## Variables identified by Maike as redundant
redundant_cols <-
  c(
    'slp_weekave_atlantic_ocean_mean',
    'h_850_weekave_conus_mean',
    'h_850_weekave_atlantic_ocean_pc4',
    'h_850_weekave_mexico_gulf_mean',
    'slp_weekave_mexico_gulf_mean',
    'slp_weekave_conus_pc1',
    'ts_weekave_conus_pc1',
    'slp_weekave_atlantic_trop_mean',
    'ts_weekave_southern_canada_pc1',
    't_850_weekave_southern_canada_mean',
    'h_850_weekave_atlantic_ocean_pc5',
    'slp_weekave_atlantic_ocean_pc6',
    'h_500_weekave_pacific_trop_mean',
    'h_850_weekave_atlantic_trop_mean',
    't_500_weekave_pacific_trop_mean',
    't_500_weekave_atlantic_trop_pc1',
    'h_850_weekave_pacific_ocean_pc1',
    't_850_weekave_conus_pc1',
    'slp_weekave_atlantic_ocean_pc1',
    'slp_weekave_pacific_trop_mean',
    't_850_weekave_southern_canada_pc1',
    'h_850_weekave_arctic_pc1',
    'h_500_weekave_atlantic_trop_mean',
    'h_850_weekave_atlantic_ocean_pc2',
    'slp_weekave_atlantic_ocean_pc3',
    'h_850_weekave_atlantic_ocean_pc7',
    't_500_weekave_mexico_gulf_mean',
    't_500_weekave_southern_canada_pc1',
    'slp_weekave_pacific_trop_pc2',
    'h_850_weekave_arctic_mean',
    'ts_weekave_atlantic_trop_mean',
    'h_850_weekave_pacific_trop_mean'
  )

climate_inputs <-
  readr::read_csv(
    paste0(fp, "analysis-data/weekly_aves_regional_inputs_1980_2020.csv"),
    show_col_types = FALSE
  ) |>
  mutate(date = as.character(date)) |>
  separate(date, into = c("year", "week"), sep = 4, remove = FALSE) |>
  mutate(
    year = as.numeric(year),
    week = as.numeric(week)
  ) |>
  select(-all_of(redundant_cols))
```

Prepared variable names to attach to feature importance results (warning is okay and is due to separation of variable with different lengths):

```{r}
input_vars <- 
  data.frame(var = c(names(climate_inputs)[-c(1:3)], "temp")) |> 
  mutate(var = str_remove(var, "weekave_")) |>
  separate(
    var,
    into = c("var1", "var2", "var3", "var4", "var5"),
    remove = FALSE
  ) |>
  rename(climate_var = var1) |>
  mutate(
    climate_var = ifelse(
      var2 %in% c("500", "850"), 
      paste0(climate_var, var2), 
      climate_var
  )) |>
  mutate(
    var2 = ifelse(
      var2 %in% c("500", "850"), 
      NA, 
      var2
  )) |> 
  rename(input_region = var2) |>
  mutate(
    var6 = ifelse(
      str_detect(var3, "pc"),
      var3, 
      ifelse(
        str_detect(var3, "mean"), 
        var3, 
        NA
      )
    )
  ) |>
  mutate(
    var3 = ifelse(
      str_detect(var3, "pc"),
      NA, 
      ifelse(
        str_detect(var3, "mean"), 
        NA, 
        var3
      )
    )
  ) |>
  mutate(
    input_region = ifelse(
      is.na(var3),
      input_region, 
      ifelse(
        is.na(input_region),
        var3, 
        paste0(input_region, "_", var3) 
      )
  )) |>
  select(-var3) |>
  mutate(
    var7 = ifelse(
      str_detect(var4, "pc"),
      var4, 
      ifelse(
        str_detect(var4, "mean"), 
        var4, 
        NA
      )
    )
  ) |>
  mutate(
    var4 = ifelse(
      str_detect(var4, "pc"),
      NA, 
      ifelse(
        str_detect(var4, "mean"), 
        NA, 
        var4
      )
    )
  ) |>
  mutate(
    input_region = ifelse(
      is.na(var4),
      input_region,  
      ifelse(
        is.na(input_region),
        var4, 
        paste0(input_region, "_", var4) 
      )
  )) |>
  select(-var4) |>
  rename(stat = var5) |>
  mutate(
    stat = ifelse(
      is.na(stat) & is.na(var6), 
      var7,
      ifelse(
        is.na(stat) & is.na(var7),
        var6, 
        stat
      )
  )) |>
  select(-var6, -var7) |>
  mutate(
    input_region = ifelse(is.na(input_region), "temp", input_region),
    stat = ifelse(is.na(stat), "temp", stat)
  ) |>
  mutate(var_id = 1:n()) |> 
  select(var_id, everything())
```

# FI Results
Determine files containing ESN feature importance results: 

```{r}
fi_fp = paste0(fp, "agu-manuscript-code/EESNs/02-grouped-feature-importance/results/GPFI-nreps01/")
fi_files = list.files(fi_fp)
fi_files = fi_files[str_detect(fi_files, "targetregion")]
```

Load in groups from Maike:

```{r}
`%ni%` <- Negate(`%in%`)
clusters <-  readr::read_csv(paste0(
  fp, "agu-manuscript-code/EESNs/02-grouped-feature-importance/02.1-InitialFeatureImportance/All_GPFI_Merged.csv")) |>
  select(Group, Feature, Region, Horizon) |> 
  mutate(middle = substr(Feature, 3, 6)) |> 
  filter(middle %ni% c("_lag", "lag_")) |> 
  select(-middle)

```

Join Feature Importance with Groups

```{r}
input_vars_with_groups <- 
  clusters |>
  mutate(var = str_remove_all(Feature, "_weekave")) |> 
  rename(tau = Horizon,
         region = Region) |> 
  left_join(input_vars, by="var") |> 
  select(-Feature, -var_id)
```

Load ESN feature importance results: 

```{r}
fi_df <-
  set_names(fi_files) |>
  map(
    .f = function(x)
      read.csv(paste0(fi_fp, x)) |> mutate(Group = 1:n())
  ) |>
  list_rbind(names_to = "file") |> 
  mutate(file = str_remove(file, ".csv")) |>
  separate(file, into = c("region", "tau", "m", "nh", "nu")) |>
  mutate(
    region = str_remove(region, "targetregion"),
    tau = as.numeric(str_remove(tau, "tau")),
    m = as.numeric(str_remove(m, "m")),
    nh = as.numeric(str_remove(nh, "nh")),
    nu = as.numeric(str_remove(nu, "nu")), 
    fi = -fi
  ) |> 
  left_join(input_vars_with_groups, by = c("Group", "tau", "region")) |>
  filter(!is.na(fi)) |> 
  select(region:nu, Group:stat, fi)
```

Create ordered version of feature importance:

```{r}
fi_ordered <- 
  fi_df |> 
  group_by(region, tau) |> 
  arrange(region, tau, desc(fi)) |> 
  mutate(rank = dense_rank(desc(fi))) |> 
  ungroup() 
```

Save data: 

```{r}
write.csv(
  fi_ordered,
  "../results/gpfi-initial.csv",
  row.names = FALSE
)
```

## Most important Groups by Region and Horizon

```{r}
## Subtitles
subtitles <- fi_df |> 
  summarise(m = mean(m),
            nu = mean(nu),
            nh = mean(nh),
            .by = c(region, tau)) |> 
  mutate(st = paste0("m:", m, " nu:", nu, " nh:", nh))

## Vars in Groups
groupvars <- fi_df |> 
  group_by(region, tau, Group) |> 
  summarise(groupvars = paste(var, collapse = ",\n")) 

## Ordered df
fi_ave_ordered <-
  fi_ordered |> 
  summarise(
    fi_ave = mean(fi), 
    fi_min = min(fi),
    fi_max = max(fi),
    .by = c(region, tau, Group)
  ) |> 
  group_by(region, tau) |>
  arrange(tau, desc(fi_ave)) |>
  mutate(rank = dense_rank(desc(fi_ave))) |> 
  ungroup() |> 
  left_join(subtitles, by=c("region", "tau")) |> 
  left_join(groupvars, by=c("region", "tau", "Group"))

## Max FI
fi_max <- fi_ave_ordered |>
  na.omit() |> 
  group_by(region) |> 
  summarise(plot_max = max(fi_ave, na.omit=F))


```

#### MW
```{r}
#| fig-height: 9
#| fig-width: 9
#| echo: FALSE
 
## Tau = 1
MW1_data <- fi_ave_ordered |> 
  filter(region == 'MW',
         tau == 1,
         rank < 6)
MW1_plot <- MW1_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[1])) +
    labs(x = "PFI", y = "Group", 
         title = "MW - Horizon 1",
         subtitle = subtitles$st[1]) +
    scale_y_discrete(labels = as.character(rev(MW1_data$groupvars)))


## Tau = 2
MW2_data <- fi_ave_ordered |> 
  filter(region == 'MW',
         tau == 2,
         rank < 6)
MW2_plot <- MW2_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[1])) +
    labs(x = "PFI", y = "Group", 
         title = "MW - Horizon 2",
         subtitle = subtitles$st[2]) +
    scale_y_discrete(labels = as.character(rev(MW2_data$groupvars)))


## Tau = 3
MW3_data <- fi_ave_ordered |> 
  filter(region == 'MW',
         tau == 3,
         rank < 6)
MW3_plot <- MW3_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[1])) +
    labs(x = "PFI", y = "Group",
         title = "MW - Horizon 3",
         subtitle = subtitles$st[3]) +
    scale_y_discrete(labels = as.character(rev(MW3_data$groupvars)))


## Tau = 4
MW4_data <- fi_ave_ordered |> 
  filter(region == 'MW',
         tau == 4,
         rank < 6)
MW4_plot <- MW4_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[1])) +
    labs(x = "PFI", y = "Group",          
         title = "MW - Horizon 4",
         subtitle = subtitles$st[4]) +
    scale_y_discrete(labels = as.character(rev(MW4_data$groupvars)))

## Plot Grid
grid.arrange(MW1_plot, MW2_plot, MW3_plot, MW4_plot, ncol = 2)

```



#### NE
```{r}
#| fig-height: 9
#| fig-width: 9
#| echo: FALSE
 
## Tau = 1
NE1_data <- fi_ave_ordered |> 
  filter(region == 'NE',
         tau == 1,
         rank < 6)
NE1_plot <- NE1_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[2])) +
    labs(x = "PFI", y = "Group",         
         title = "NE - Horizon 1",
         subtitle = subtitles$st[5]) +
    scale_y_discrete(labels = as.character(rev(NE1_data$groupvars)))


## Tau = 2
NE2_data <- fi_ave_ordered |> 
  filter(region == 'NE',
         tau == 2,
         rank < 6)
NE2_plot <- NE2_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[2])) +
    labs(x = "PFI", y = "Group",          
         title = "NE - Horizon 2",
         subtitle = subtitles$st[6]) +
    scale_y_discrete(labels = as.character(rev(NE2_data$groupvars)))


## Tau = 3
NE3_data <- fi_ave_ordered |> 
  filter(region == 'NE',
         tau == 3,
         rank < 6)
NE3_plot <- NE3_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[2])) +
    labs(x = "PFI", y = "Group",         
         title = "NE - Horizon 3",
         subtitle = subtitles$st[7]) +
    scale_y_discrete(labels = as.character(rev(NE3_data$groupvars)))


## Tau = 4
NE4_data <- fi_ave_ordered |> 
  filter(region == 'NE',
         tau == 4,
         rank < 6)
NE4_plot <- NE4_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[2])) +
    labs(x = "PFI", y = "Group",         
         title = "NE - Horizon 4",
         subtitle = subtitles$st[8]) +
    scale_y_discrete(labels = as.character(rev(NE4_data$groupvars)))

## Plot Grid
grid.arrange(NE1_plot, NE2_plot, NE3_plot, NE4_plot, ncol = 2)

```


#### SE
```{r}
#| fig-height: 9
#| fig-width: 9
#| echo: FALSE
 
## Tau = 1
SE1_data <- fi_ave_ordered |> 
  filter(region == 'SE',
         tau == 1,
         rank < 6)
SE1_plot <- SE1_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[3])) +
    labs(x = "PFI", y = "Group",         
         title = "SE - Horizon 1",
         subtitle = subtitles$st[9]) +
    scale_y_discrete(labels = as.character(rev(SE1_data$groupvars)))


## Tau = 2
SE2_data <- fi_ave_ordered |> 
  filter(region == 'SE',
         tau == 2,
         rank < 6)
SE2_plot <- SE2_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[3])) +
    labs(x = "PFI", y = "Group",         
         title = "SE - Horizon 2",
         subtitle = subtitles$st[10]) +
    scale_y_discrete(labels = as.character(rev(SE2_data$groupvars)))


## Tau = 3
SE3_data <- fi_ave_ordered |> 
  filter(region == 'SE',
         tau == 3,
         rank < 6)
SE3_plot <- SE3_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[3])) +
    labs(x = "PFI", y = "Group",          
         title = "SE - Horizon 3",
         subtitle = subtitles$st[11]) +
    scale_y_discrete(labels = as.character(rev(SE3_data$groupvars)))


## Tau = 4
SE4_data <- fi_ave_ordered |> 
  filter(region == 'SE',
         tau == 4,
         rank < 6)
SE4_plot <- SE4_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[3])) +
    labs(x = "PFI", y = "Group",          
         title = "SE - Horizon 4",
         subtitle = subtitles$st[12]) +
    scale_y_discrete(labels = as.character(rev(SE4_data$groupvars)))

## Plot Grid
grid.arrange(SE1_plot, SE2_plot, SE3_plot, SE4_plot, ncol = 2)

```



#### SW
```{r}
#| fig-height: 9
#| fig-width: 9
#| echo: FALSE
 
## Tau = 1
SW1_data <- fi_ave_ordered |> 
  filter(region == 'SW',
         tau == 1,
         rank < 6)
SW1_plot <- SW1_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[4])) +
    labs(x = "PFI", y = "Group",          
         title = "SW - Horizon 1",
         subtitle = subtitles$st[13]) +
    scale_y_discrete(labels = as.character(rev(SW1_data$groupvars)))


## Tau = 2
SW2_data <- fi_ave_ordered |> 
  filter(region == 'SW',
         tau == 2,
         rank < 6)
SW2_plot <- SW2_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[4])) +
    labs(x = "PFI", y = "Group",          
         title = "SW - Horizon 2",
         subtitle = subtitles$st[14]) +
    scale_y_discrete(labels = as.character(rev(SW2_data$groupvars)))


## Tau = 3
SW3_data <- fi_ave_ordered |> 
  filter(region == 'SW',
         tau == 3,
         rank < 6)
SW3_plot <- SW3_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[4])) +
    labs(x = "PFI", y = "Group",          
         title = "SW - Horizon 3",
         subtitle = subtitles$st[15]) +
    scale_y_discrete(labels = as.character(rev(SW3_data$groupvars)))


## Tau = 4
SW4_data <- fi_ave_ordered |> 
  filter(region == 'SW',
         tau == 4,
         rank < 6)
SW4_plot <- SW4_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[4])) +
    labs(x = "PFI", y = "Group",          
         title = "SW - Horizon 4",
         subtitle = subtitles$st[16]) +
    scale_y_discrete(labels = as.character(rev(SW4_data$groupvars)))

## Plot Grid
grid.arrange(SW1_plot, SW2_plot, SW3_plot, SW4_plot, ncol = 2)

```


#### W
```{r}
#| fig-height: 9
#| fig-width: 9
#| echo: FALSE
 
## Tau = 1
W1_data <- fi_ave_ordered |> 
  filter(region == 'W',
         tau == 1,
         rank < 6)
W1_plot <- W1_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[5])) +
    labs(x = "PFI", y = "Group", 
         title = "W - Horizon 1",
         subtitle = subtitles$st[17]) +
    scale_y_discrete(labels = as.character(rev(W1_data$groupvars)))


## Tau = 2
W2_data <- fi_ave_ordered |> 
  filter(region == 'W',
         tau == 2,
         rank < 6)
W2_plot <- W2_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[5])) +
    labs(x = "PFI", y = "Group", 
         title = "W - Horizon 2",
         subtitle = subtitles$st[18]) +
    scale_y_discrete(labels = as.character(rev(W2_data$groupvars)))


## Tau = 3
W3_data <- fi_ave_ordered |> 
  filter(region == 'W',
         tau == 3,
         rank < 6)
W3_plot <- W3_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[5])) +
    labs(x = "PFI", y = "Group",
         title = "W - Horizon 3",
         subtitle = subtitles$st[19]) +
    scale_y_discrete(labels = as.character(rev(W3_data$groupvars)))


## Tau = 4
W4_data <- fi_ave_ordered |> 
  filter(region == 'W',
         tau == 4,
         rank < 6)
W4_plot <- W4_data|> 
  mutate(str_rank = as.factor(-rank)) |> 
  ggplot(aes(y=str_rank, x=fi_ave)) +
    geom_point(size=3) +
    xlim(c(0, fi_max$plot_max[5])) +
    labs(x = "PFI", y = "Group",          
         title = "W - Horizon 4",
         subtitle = subtitles$st[20]) +
    scale_y_discrete(labels = as.character(rev(W4_data$groupvars)))

## Plot Grid
grid.arrange(W1_plot, W2_plot, W3_plot, W4_plot, ncol = 2)

```


#### Averaged (over forecast region)

Compute average FI for each forecast horizon and input variable (averaged over forecast region):
  
```{r}
fi_ave_ordered <-
  fi_ordered |> 
  summarise(
    fi_ave = mean(fi), 
    fi_min = min(fi),
    fi_max = max(fi),
    .by = c(tau, var)
  ) |> 
  group_by(tau) |>
  arrange(tau, desc(fi_ave)) |>
  mutate(rank = row_number()) |> 
  ungroup()
```

Extract the 25 variables with the highest average feature importance (for each horizon):
  
```{r}
fi_ave_ordered_sub1 <-
  fi_ave_ordered |>
  filter(rank <= 25, tau == 1) |>
  mutate(rank = factor(rank, levels = 25:1))

fi_ave_ordered_sub2 <-
  fi_ave_ordered |>
  filter(rank <= 25, tau == 2) |>
  mutate(rank = factor(rank, levels = 25:1))

fi_ave_ordered_sub3 <-
  fi_ave_ordered |>
  filter(rank <= 25, tau == 3) |>
  mutate(rank = factor(rank, levels = 25:1))

fi_ave_ordered_sub4 <-
  fi_ave_ordered |>
  filter(rank <= 25, tau == 4) |>
  mutate(rank = factor(rank, levels = 25:1))
```

Plots of average FI plus/minus minimum and maximum FI values (averaged over forecast region):
  
```{r}
#| fig-height: 15
#| fig-width: 30
#| echo: FALSE

fi_ave_ordered_sub1 |>
  ggplot(aes(x = rank, y = fi_ave)) +
  geom_point(size = 5) +
  geom_errorbar(
    mapping = aes(ymin = fi_min, ymax = fi_max),
    width = 0,
    linewidth = 1
  ) +
  coord_flip() +
  facet_wrap(. ~ tau, scales = "free_y", ncol = 5) +
  scale_x_discrete(labels = rev(fi_ave_ordered_sub1$var)) +
  theme_light(base_size = 24) +
  labs(y = "PFI", x = "Input Variable", title = "Forecast Horizon: 1")

fi_ave_ordered_sub2 |>
  ggplot(aes(x = rank, y = fi_ave)) +
  geom_point(size = 5) +
  geom_errorbar(
    mapping = aes(ymin = fi_min, ymax = fi_max),
    width = 0,
    linewidth = 1
  ) +
  coord_flip() +
  facet_wrap(. ~ tau, scales = "free_y", ncol = 5) +
  scale_x_discrete(labels = rev(fi_ave_ordered_sub2$var)) +
  theme_light(base_size = 24) +
  labs(y = "PFI", x = "Input Variable", title = "Forecast Horizon: 2")

fi_ave_ordered_sub3 |>
  ggplot(aes(x = rank, y = fi_ave)) +
  geom_point(size = 5) +
  geom_errorbar(
    mapping = aes(ymin = fi_min, ymax = fi_max),
    width = 0,
    linewidth = 1
  ) +
  coord_flip() +
  facet_wrap(. ~ tau, scales = "free_y", ncol = 5) +
  scale_x_discrete(labels = rev(fi_ave_ordered_sub3$var)) +
  theme_light(base_size = 24) +
  labs(y = "PFI", x = "Input Variable", title = "Forecast Horizon: 3")

fi_ave_ordered_sub4 |>
  ggplot(aes(x = rank, y = fi_ave)) +
  geom_point(size = 5) +
  geom_errorbar(
    mapping = aes(ymin = fi_min, ymax = fi_max),
    width = 0,
    linewidth = 1
  ) +
  coord_flip() +
  facet_wrap(. ~ tau, scales = "free_y", ncol = 5) +
  scale_x_discrete(labels = rev(fi_ave_ordered_sub4$var)) +
  theme_light(base_size = 24) +
  labs(y = "PFI", x = "Input Variable", title = "Forecast Horizon: 4")
```

## Averaged (over forecast region, input region, and stat)

Compute average FI by forecast horizon and input climate variable:
  
```{r}
fi_ordered_ave_by_tau_climvar <-
  fi_ordered |> 
  summarise(
    fi_ave = mean(fi), 
    fi_min = min(fi),
    fi_max = max(fi),
    .by = c(tau, climate_var)
  ) |> 
  group_by(tau) |>
  arrange(tau, desc(fi_ave)) |>
  mutate(rank = row_number()) |> 
  ungroup()
```

Extract the 25 variables with the highest average feature importance (for each horizon):
  
```{r}
fi_ordered_ave_by_tau_climvar_sub1 <-
  fi_ordered_ave_by_tau_climvar |>
  filter(rank <= 25, tau == 1) |>
  mutate(rank = factor(rank, levels = 25:1))

fi_ordered_ave_by_tau_climvar_sub2 <-
  fi_ordered_ave_by_tau_climvar |>
  filter(rank <= 25, tau == 2) |>
  mutate(rank = factor(rank, levels = 25:1))

fi_ordered_ave_by_tau_climvar_sub3 <-
  fi_ordered_ave_by_tau_climvar |>
  filter(rank <= 25, tau == 3) |>
  mutate(rank = factor(rank, levels = 25:1))

fi_ordered_ave_by_tau_climvar_sub4 <-
  fi_ordered_ave_by_tau_climvar |>
  filter(rank <= 25, tau == 4) |>
  mutate(rank = factor(rank, levels = 25:1))
```

Plots of average FI plus/minus minimum and maximum FI values (averaged over forecast region):
  
```{r}
#| fig-height: 10
#| fig-width: 30
#| echo: FALSE

fi_ordered_ave_by_tau_climvar_sub1 |>
  ggplot(aes(x = rank, y = fi_ave)) +
  geom_point(size = 5) +
  geom_errorbar(
    mapping = aes(ymin = fi_min, ymax = fi_max),
    width = 0,
    linewidth = 1
  ) +
  coord_flip() +
  facet_wrap(. ~ tau, scales = "free_y", ncol = 5) +
  scale_x_discrete(labels = rev(fi_ordered_ave_by_tau_climvar_sub1$climate_var)) +
  theme_light(base_size = 24) +
  labs(y = "PFI", x = "Input Climate Variable", title = "Forecast Horizon: 1")

fi_ordered_ave_by_tau_climvar_sub2 |>
  ggplot(aes(x = rank, y = fi_ave)) +
  geom_point(size = 5) +
  geom_errorbar(
    mapping = aes(ymin = fi_min, ymax = fi_max),
    width = 0,
    linewidth = 1
  ) +
  coord_flip() +
  facet_wrap(. ~ tau, scales = "free_y", ncol = 5) +
  scale_x_discrete(labels = rev(fi_ordered_ave_by_tau_climvar_sub2$climate_var)) +
  theme_light(base_size = 24) +
  labs(y = "PFI", x = "Input Climate Variable", title = "Forecast Horizon: 2")

fi_ordered_ave_by_tau_climvar_sub3 |>
  ggplot(aes(x = rank, y = fi_ave)) +
  geom_point(size = 5) +
  geom_errorbar(
    mapping = aes(ymin = fi_min, ymax = fi_max),
    width = 0,
    linewidth = 1
  ) +
  coord_flip() +
  facet_wrap(. ~ tau, scales = "free_y", ncol = 5) +
  scale_x_discrete(labels = rev(fi_ordered_ave_by_tau_climvar_sub3$climate_var)) +
  theme_light(base_size = 24) +
  labs(y = "PFI", x = "Input Climate Variable", title = "Forecast Horizon: 3")

fi_ordered_ave_by_tau_climvar_sub4 |>
  ggplot(aes(x = rank, y = fi_ave)) +
  geom_point(size = 5) +
  geom_errorbar(
    mapping = aes(ymin = fi_min, ymax = fi_max),
    width = 0,
    linewidth = 1
  ) +
  coord_flip() +
  facet_wrap(. ~ tau, scales = "free_y", ncol = 5) +
  scale_x_discrete(labels = rev(fi_ordered_ave_by_tau_climvar_sub4$climate_var)) +
  theme_light(base_size = 24) +
  labs(y = "PFI", x = "Input Climate Variable", title = "Forecast Horizon: 4")
```

## FI by Variable

Input region:
  
```{r}
#| fig-height: 8
#| fig-width: 30
#| echo: FALSE

fi_ordered |>
  ggplot(aes(y = input_region, x = fi)) + 
  geom_violin() +
  geom_point() +
  facet_grid(. ~ tau, scales = "free_x") + 
  theme_light(base_size = 24) +
  labs(x = "PFI (note different scales)", y = "Input Region")
```

Statistic:
  
```{r}
#| fig-height: 8
#| fig-width: 30
#| echo: FALSE

fi_ordered |>
  ggplot(aes(y = stat, x = fi)) + 
  geom_violin() +
  geom_point() +
  facet_grid(. ~ tau, scales = "free_x") + 
  theme_light(base_size = 24) +
  labs(x = "PFI (note different scales)", y = "Stat")
```

Forecast region:
  
```{r}
#| fig-height: 8
#| fig-width: 30
#| echo: FALSE

fi_ordered |>
  ggplot(aes(y = region, x = fi)) + 
  geom_violin() +
  geom_point() +
  facet_grid(. ~ tau, scales = "free_x") + 
  theme_light(base_size = 24) +
  labs(x = "PFI (note different scales)", y = "Forecast Region")
```

Climate variable: 
  
```{r}
#| fig-height: 8
#| fig-width: 30
#| echo: FALSE

fi_ordered |>
  ggplot(aes(y = climate_var, x = fi)) + 
  geom_violin() +
  geom_point() +
  facet_grid(. ~ tau, scales = "free_x") + 
  theme_light(base_size = 24) +
  labs(x = "PFI (note different scales)", y = "Climate Variable", title = "All Variables")

fi_ordered |>
  ggplot(aes(y = climate_var, x = log(fi + 000000.1))) + 
  geom_violin() +
  geom_point() +
  facet_grid(. ~ tau, scales = "free_x") + 
  theme_light(base_size = 24) +
  labs(x = "PFI (note different scales)", y = "Climate Variable", title = "Log Scale")

fi_ordered |>
  filter(climate_var != "slp") |>
  ggplot(aes(y = climate_var, x = fi)) + 
  geom_violin() +
  geom_point() +
  facet_grid(. ~ tau, scales = "free_x") + 
  theme_light(base_size = 24) +
  labs(x = "PFI (note different scales)", y = "Climate Variable", title = "SLP Removed")
```

## Top 100

```{r}
#| fig-height: 15
#| fig-width: 30
#| echo: FALSE

fi_df_sub <- 
  fi_ordered |> 
  filter(rank <= 100)

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = climate_var, color = climate_var)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 20) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 5, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 5, type = "continuous"))

fi_df_sub |> 
  mutate(stat = factor(str_remove(stat, "pc"), levels = 1:20)) |>
  ggplot(aes(x = rank, y = fi)) + 
  geom_col(aes(fill = stat, color = stat)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 20) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous"))

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = input_region, color = input_region)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 20) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 13, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 13, type = "continuous"))
```

## Top 50

```{r}
#| fig-height: 15
#| fig-width: 30
#| echo: FALSE

fi_df_sub <- 
  fi_ordered |> 
  filter(rank <= 50)

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = climate_var, color = climate_var)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 5, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 5, type = "continuous"))

fi_df_sub |> 
  mutate(stat = factor(str_remove(stat, "pc"), levels = 1:20)) |>
  ggplot(aes(x = rank, y = fi)) + 
  geom_col(aes(fill = stat, color = stat)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous"))

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = input_region, color = input_region)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 9, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 9, type = "continuous"))
```

## Top 25

```{r}
#| fig-height: 15
#| fig-width: 30
#| echo: FALSE
fi_df_sub <- 
  fi_ordered |> 
  filter(rank <= 25)

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = climate_var, color = climate_var)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 4, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 4, type = "continuous"))

fi_df_sub |> 
  mutate(stat = factor(str_remove(stat, "pc"), levels = 1:20)) |>
  ggplot(aes(x = rank, y = fi)) + 
  geom_col(aes(fill = stat, color = stat)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous"))

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = input_region, color = input_region)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free_y", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 9, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 9, type = "continuous"))
```

## Top 100 (marginal)

```{r}
#| fig-height: 15
#| fig-width: 30
#| echo: FALSE

fi_df_sub <- 
  fi_ordered |> 
  filter(rank <= 100)

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = climate_var, color = climate_var)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 20) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 5, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 5, type = "continuous"))

fi_df_sub |> 
  mutate(stat = factor(str_remove(stat, "pc"), levels = 1:20)) |>
  ggplot(aes(x = rank, y = fi)) + 
  geom_col(aes(fill = stat, color = stat)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 20) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous"))

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = input_region, color = input_region)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 20) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 13, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 13, type = "continuous"))
```

## Top 50 (marginal)

```{r}
#| fig-height: 15
#| fig-width: 30
#| echo: FALSE

fi_df_sub <- 
  fi_ordered |> 
  filter(rank <= 50)

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = climate_var, color = climate_var)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 5, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 5, type = "continuous"))

fi_df_sub |> 
  mutate(stat = factor(str_remove(stat, "pc"), levels = 1:20)) |>
  ggplot(aes(x = rank, y = fi)) + 
  geom_col(aes(fill = stat, color = stat)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous"))

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = input_region, color = input_region)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 9, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 9, type = "continuous"))
```

## Top 25 (marginal)

```{r}
#| fig-height: 15
#| fig-width: 30
#| echo: FALSE
fi_df_sub <- 
  fi_ordered |> 
  filter(rank <= 25)

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = climate_var, color = climate_var)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 4, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 4, type = "continuous"))

fi_df_sub |> 
  mutate(stat = factor(str_remove(stat, "pc"), levels = 1:20)) |>
  ggplot(aes(x = rank, y = fi)) + 
  geom_col(aes(fill = stat, color = stat)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 20, type = "continuous"))

ggplot(fi_df_sub, aes(x = rank, y = fi)) + 
  geom_col(aes(fill = input_region, color = input_region)) +
  coord_flip() + 
  facet_wrap(. ~ tau + region, scales = "free", ncol = 5) +
  scale_x_reverse() +
  theme_light(base_size = 24) + 
  labs(
    y = "PFI",
    x = "Rank"
  ) + 
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 9, type = "continuous")) +
  scale_color_manual(values = wes_palette(name = "Zissou1", n = 9, type = "continuous"))
```